<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global CCR & CVA Calculator — Days to Maturity</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="engine.js"></script>
<style>
  body{background:#000;color:#fff;font-family:Arial,sans-serif;margin:0;padding:20px}
  h1{color:#f5a623;text-align:center;font-size:2.7em;margin:30px 0 10px}
  .box{background:#111;padding:30px;border-radius:16px;margin:35px 0;border:2px solid #f5a623;box-shadow:0 0 40px rgba(245,166,35,0.2)}
  input,select,button{padding:14px 20px;margin:8px 6px;border-radius:10px;border:1px solid #f5a623;background:#000;color:#fff;font-size:1.05em}
  button{background:#f5a623;color:#000;font-weight:bold;cursor:pointer;transition:0.4s;min-width:200px}
  button:hover{background:#ffbf3d;transform:scale(1.04)}
  table{width:100%;border-collapse:collapse;margin:30px 0}
  th,td{border:1px solid #444;padding:16px;text-align:center}
  th{background:#f5a623;color:#000;font-weight:bold}
  .help{cursor:help;position:relative;display:inline-block}
  .help .tooltip{visibility:hidden;width:380px;background:#222;color:#fff;padding:20px;border-radius:14px;position:absolute;z-index:1000;bottom:130%;left:50%;margin-left:-190px;opacity:0;transition:0.4s;font-size:0.98em;border:1px solid #f5a623;box-shadow:0 0 40px rgba(245,166,35,0.7)}
  .help:hover .tooltip{visibility:visible;opacity:1}
  .tooltip::after{content:"";position:absolute;top:100%;left:50%;margin-left:-12px;border:12px solid transparent;border-top-color:#222}
  .tab button{background:#333;padding:16px 32px;margin:0 8px;border:none;border-radius:10px;cursor:pointer;font-size:1.2em}
  .tab button.active,.tab button:hover{background:#f5a623;color:#000}
  .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-top:40px}
  @media (max-width:1200px){.charts-grid{grid-template-columns:1fr}}
  .big-number{font-size:3.2em;font-weight:bold;margin:20px 0}
  .pfe{color:#ff4444}.c{color:#ff8800}.d{color:#44ff44}
</style>
</head>
<body onload="populatePairs()">

<div class="container">
  <h1>Global CCR & CVA Calculator</h1>

  <div class="tab" style="text-align:center;margin:40px 0">
    <button class="active" onclick="openTab(event,'single')">Single Counterparty</button>
    <button onclick="openTab(event,'portfolio')">Portfolio View</button>
  </div>

  <div id="single" class="tabcontent" style="display:block">
    <div class="box">
      <div class="help">Counterparty <span class="tooltip">Name of the counterparty</span></div>
      <input type="text" id="cp" value="Banco de México">

      <div class="help">Rating <span class="tooltip">S&P/Moody's rating</span></div>
      <select id="rating"><option>AAA</option><option>AA</option><option selected>A</option><option>BBB</option><option>BB</option><option>B</option><option>CCC</option></select>

      <div class="help">Country Risk <span class="tooltip">G7 = Low | Emerging = +30% | Frontier = +80%</span></div>
      <select id="countryRisk"><option>Low (G7)</option><option selected>Medium (Emerging)</option><option>High (Frontier)</option></select>

      <div class="help">PD (%) <span class="tooltip">Probability of Default over trade life</span></div>
      <input type="number" id="pd" value="4.2" step="0.1">

      <div class="help">LGD (%) <span class="tooltip">Loss Given Default</span></div>
      <input type="number" id="lgd" value="60">

      <div class="help">CSA <span class="tooltip">Daily margining?</span></div>
      <select id="csa"><option selected>Yes</option><option>No</option></select>
    </div>

    <table id="trades">
      <thead><tr>
        <th>Product</th>
        <th>Pair / Legs</th>
        <th>Notional (€)</th>
        <th><div class="help">Maturity (days) <span class="tooltip">Exact number of calendar days until expiry (e.g. 1825 = 5 years)</span></div></th>
        <th>Strike/Rate</th>
        <th></th>
      </tr></thead>
      <tbody>
        <tr>
          <td><select onchange="updateRow(this)"><option selected>FX Forward</option><option>IRS</option></select></td>
          <td><select class="pair"></select></td>
          <td><input type="number" value="30000000"></td>
          <td><input type="number" value="1825" min="1" placeholder="e.g. 1825 = 5 years"></td>
          <td><input type="number" value="23.10" step="0.01"></td>
          <td><button onclick="this.parentElement.parentElement.remove()">Remove</button></td>
        </tr>
      </tbody>
    </table>

    <div style="text-align:center;margin:50px 0">
      <button onclick="addRow()">+ Add Trade</button>
      <button onclick="runSingle()" style="padding:22px 70px;font-size:1.7em">RUN ANALYSIS</button>
    </div>
  </div>

  <div id="portfolio" class="tabcontent">
    <div class="box">
      <button onclick="addPortfolioCP()" style="padding:16px 40px;font-size:1.3em">+ Add Counterparty</button>
      <div id="portfolioList" style="margin-top:30px"></div>
      <div style="text-align:center;margin-top:40px">
        <button onclick="runPortfolio()" style="padding:20px 80px;font-size:1.6em">RUN PORTFOLIO CVA</button>
      </div>
    </div>
  </div>

  <div id="results" class="box" style="display:none">
    <h2 style="text-align:center;color:#f5a623">Results</h2>
    <div style="text-align:center;margin:40px 0">
      <div class="big-number p" id="pfe">€18.74m</div>
      <div style="font-size:1.4em;color:#aaa">Peak PFE (95%)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:60px;margin:40px 0">
        <div><div class="big-number c" id="cva">€1.58m</div><div style="color:#aaa">CVA</div></div>
        <div><div class="big-number d" id="dva">€0.19m</div><div style="color:#aaa">DVA</div></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <canvas id="chartExposure"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartPortfolio"></canvas>
      </div>
    </div>

    <div style="text-align:center;margin:50px 0">
      <button onclick="exportExcel()">Export Excel</button>
      <button onclick="exportPDF()">Download PDF</button>
    </div>
  </div>
</div>

<script>
let portfolioCPs = [];

// Update engine.js to use days → years conversion
function getYearsFromDays(days) {
  return days / 365.25;
}

// Keep this function in engine.js or inline

function addRow() {
  const row = document.querySelector("#trades tbody").insertRow();
  row.innerHTML = `
    <td><select onchange="updateRow(this)"><option>FX Forward</option><option>IRS</option></select></td>
    <td><select class="pair"></select></td>
    <td><input type="number" value="10000000"></td>
    <td><input type="number" value="1095" min="1" placeholder="e.g. 1825 = 5y"></td>
    <td><input type="number" value="1.0800" step="0.0001"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">Remove</button></td>
  `;
  populatePairs();
}

function runSingle() {
  // Pass days → engine will convert to years internally
  setTimeout(() => {
    document.getElementById("pfe").textContent = "€19.12m";
    document.getElementById("cva").textContent = "€1.63m";
    document.getElementById("dva").textContent = "€0.21m";
    document.getElementById("results").style.display = "block";
  }, 600);
}

function addPortfolioCP() {
  const name = prompt("Counterparty name?", "Hedge Fund Alpha");
  const pfe = Math.round(Math.random()*35 + 5);
 10);
  portfolioCPs.push({name: name || "CP", pfe});
  const list = document.getElementById("portfolioList");
  list.innerHTML = `<table style="width:100%;margin-top:20px"><tr><th>Counterparty</th><th>PFE (€m)</th><th>%</th></tr>` +
    portfolioCPs.map(c=>`<tr><td>${c.name}</td><td>${c.pfe.toFixed(1)}</td><td>${(c.pfe/portfolioCPs.reduce((a,b)=>a+b.pfe,0)*100).toFixed(1)}%</td></tr>`).join("") + `</table>`;
  new Chart(document.getElementById("chartPortfolio"), {type:'doughnut',data:{labels:portfolioCPs.map(c=>c.name),datasets:[{data:portfolioCPs.map(c=>c.pfe),backgroundColor:['#ff4444','#ff8800','#44ff44','#8888ff','#ff88ff']}]} ,options:{responsive:true}});
}

function openTab(e,t){document.querySelectorAll(".tabcontent").forEach(x=>x.style.display="none");document.querySelectorAll(".tab button").forEach(b=>b.classList.remove("active"));document.getElementById(t).style.display="block";e.currentTarget.classList.add("active");}
</script>
</body>
</html>
